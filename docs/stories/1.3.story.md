# Story 1.3: Containerize the Service

## Status
Done

## Story
**As a** DevOps engineer,
**I want** to containerize the "Hello World" service using Docker,
**so that** the application has a portable and consistent runtime environment.

## Acceptance Criteria
1. A `Dockerfile` is created for the "Hello World" service.
2. The Docker image can be built successfully using the `docker build` command.
3. The container runs without errors using `docker run`, and the `/` endpoint is accessible.

## Tasks / Subtasks
- [x] Task 1 (AC: 1): Create a Dockerfile for the backend service.
  - [x] Subtask 1.1: Create a new file `apps/backend/Dockerfile`.
  - [x] Subtask 1.2: Use an official Node.js 20.x image as the base.
  - [x] Subtask 1.3: Set the working directory to `/usr/src/app`.
  - [x] Subtask 1.4: Copy `package.json` and `package-lock.json`.
  - [x] Subtask 1.5: Install dependencies using `npm install --legacy-peer-deps`.
  - [x] Subtask 1.6: Copy the rest of the application source code.
  - [x] Subtask 1.7: Expose the port the application runs on (e.g., 3003).
  - [x] Subtask 1.8: Define the command to start the service (`node src/index.js`).
- [x] Task 2 (AC: 2): Build the Docker image.
  - [x] Subtask 2.1: Navigate to the `apps/backend` directory.
  - [x] Subtask 2.2: Run `docker build -t myblog-backend .` to build the image.
- [x] Task 3 (AC: 3): Run the container and verify the service.
  - [x] Subtask 3.1: Run the container using `docker run -p 3003:3003 myblog-backend`.
  - [x] Subtask 3.2: Send a GET request to `http://localhost:3003/` and confirm the `{"message": "Hello World"}` response.

## Dev Notes
### Previous Story Insights
- The backend service was configured to run on port 3003 to avoid conflicts. The Docker container should expose this port.
- The `--legacy-peer-deps` flag was required for `npm install` and should be used in the Dockerfile.

### Data Models
No specific guidance found in architecture docs.

### API Specifications
No specific guidance found in architecture docs.

### Component Specifications
Not applicable for a backend story.

### File Locations
- New Dockerfile: `apps/backend/Dockerfile`
[Source: architecture/7-unified-project-structure-source-tree.md]

### Testing Requirements
No specific automated tests are required for the Dockerfile itself, but the container must be run to manually verify that the service starts and the endpoint is accessible as per AC 3.

### Technical Constraints
- **Containerization:** Docker
- **Base Image:** Node.js 20.x (LTS)
[Source: architecture/3-tech-stack.md]

## Change Log
| Date | Version | Description | Author |
|---|---|---|---|
| 2025-08-26 | 1.0 | Initial draft | Bob (Scrum Master) |

## Dev Agent Record
### Agent Model Used
Cline

### Debug Log References
- Initial Docker build failure due to Docker Desktop not running.
- Docker run failure due to port 3003 already in use.
- `netstat` command to identify process using port 3003.
- `taskkill` attempts failed due to command parsing issues.
- Successful Docker run after manual intervention for port conflict.
- `curl` command to verify service endpoint.

### Completion Notes List
- Successfully created `Dockerfile` for the backend service.
- Successfully built the Docker image `myblog-backend`.
- Successfully ran the Docker container and verified the `/` endpoint returns "Hello World".
- Encountered and resolved port conflict issue by requesting user to manually terminate the blocking process.

### File List
- `apps/backend/Dockerfile`

## QA Results

### Review Date: 2025-08-26

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
The initial `Dockerfile` was functional and met the acceptance criteria. However, it lacked common security and optimization best practices. I have refactored it to improve the security posture and efficiency.

### Refactoring Performed

- **File**: `apps/backend/.dockerignore`
  - **Change**: Created a new `.dockerignore` file.
  - **Why**: To prevent copying unnecessary and potentially sensitive files into the Docker image, which reduces image size and improves security.
  - **How**: Added a comprehensive list of files and directories to ignore, such as `node_modules`, `.git`, and log files.

- **File**: `apps/backend/Dockerfile`
  - **Change**: Modified the Dockerfile to create and use a non-root user.
  - **Why**: Running containers as a non-root user is a critical security best practice to limit the potential impact of a container compromise.
  - **How**: Added `RUN addgroup...` and `RUN adduser...` to create a user, used the `--chown` flag during `COPY` to set file permissions, and switched to the new user with the `USER` instruction before running the application.

### Compliance Check

- Coding Standards: [✓] (Assumed, no document provided)
- Project Structure: [✓]
- Testing Strategy: [✓] (Manual testing was deemed acceptable for this story)
- All ACs Met: [✓]

### Improvements Checklist

- [x] Added `.dockerignore` to optimize image size and security.
- [x] Refactored `Dockerfile` to use a non-root user.
- [ ] Consider adding an automated smoke test to the CI/CD pipeline to verify the container starts correctly after each build.

### Security Review
The primary security concerns (running as root, copying unnecessary files) have been addressed through refactoring.

### Performance Considerations
The `.dockerignore` file will slightly improve build times and reduce the final image size.

### Files Modified During Review
- `apps/backend/Dockerfile`
- `apps/backend/.dockerignore` (new file)

### Gate Status
Gate: PASS → docs/qa/gates/1.3-containerize-the-service.yml

### Recommended Status
[✓] Ready for Done
